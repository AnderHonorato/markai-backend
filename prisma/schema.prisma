// backend/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String   @id @default(uuid())
  email            String   @unique
  password         String   
  type             String   // "CLIENT" ou "PROFESSIONAL"
  notificationsEnabled Boolean @default(true)
  isBlocked        Boolean  @default(false)
  blockedBy        String?  // ID do profissional que bloqueou
  pushToken        String?  // Armazena o Expo Push Token
  slug             String?  @unique // Link único: markai.app/slug
  fidelityEnabled  Boolean  @default(false)
  fidelityGoal     Int      @default(10) 
  fidelityBonus    String?  

  // Dados Pessoais
  name             String?
  phone            String?    
  avatarUrl        String?   // Foto do perfil (Base64)

  // Segurança
  isVerified       Boolean   @default(false)
  verificationCode String?   

  // Dados Profissionais
  cpf              String?
  companyName      String?
  description      String?
  openHours        String?    

  // --- ENDEREÇO ESTRUTURADO ---
  zipCode          String?    
  street           String?    
  number           String?    
  neighborhood     String?    
  city             String?    
  state            String?    
  country          String?    @default("Brasil")
  complement       String?    
   
  // Geolocalização para buscas
  latitude         Float?
  longitude        Float?
    
  // Configurações Profissional
  serviceDuration  Int       @default(60)          
  workStart        String    @default("09:00")    
  workEnd          String    @default("18:00")    

  // Financeiro
  autoOpenRegister  Boolean   @default(false)
  autoCloseRegister Boolean   @default(false)
  defaultFloat      Float     @default(0.0)

  // Métricas
  reputationScore   Float    @default(5.0) 
  totalReviews      Int      @default(0)      
  totalAppointments Int      @default(0)      
  noShowCount       Int      @default(0)      

  // Relacionamentos
  services              Service[] 
  appointmentsAsClient  Appointment[] @relation("ClientAppointments")
  appointmentsAsPro     Appointment[] @relation("ProAppointments")
  reviewsReceived       Review[]      @relation("ReviewReceiver")
  reviewsGiven          Review[]      @relation("ReviewAuthor")
  cashRegisters         CashRegister[]
  messagesSent          ChatMessage[] @relation("SentMessages")
  messagesReceived      ChatMessage[] @relation("ReceivedMessages")
  
  // --- NOVOS RELACIONAMENTOS PARA NOTAS ---
  notesWritten          ClientNote[] @relation("NotesWritten")
  notesAboutMe          ClientNote[] @relation("NotesReceived")
    
  createdAt DateTime @default(now())
}

model Service {
  id          String @id @default(uuid())
  name        String 
  price       Float  
  category    String  @default("Geral")
  imageUrl    String? 
  description String? 

  proId    String
  pro      User   @relation(fields: [proId], references: [id])
}

model Appointment {
  id             String   @id @default(uuid())
  date           DateTime 
  status         String   @default("PENDING") 
  serviceList    String?   
  totalPrice     Float    @default(0.0)
  clientConfirmed Boolean   @default(false) 
  proConfirmed    Boolean   @default(false) 
  
  clientId       String
  client         User     @relation("ClientAppointments", fields: [clientId], references: [id])
  proId          String
  professional   User     @relation("ProAppointments", fields: [proId], references: [id])

  rescheduleDate   DateTime?
  rescheduleReason String?
  rescheduleBy     String? 

  cancelReason     String?    
  cancelledBy      String?    
  
  isFinishedEarly  Boolean  @default(false)

  // MUDANÇA AQUI: "reviews" no plural e array []
  reviews          Review[] 

  createdAt DateTime @default(now())
}

model Review {
  id            String      @id @default(uuid())
  rating        Int         
  comment       String?
  
  // MUDANÇA AQUI: Removemos o @unique do appointmentId
  appointmentId String      
  appointment   Appointment @relation(fields: [appointmentId], references: [id])
  
  authorId      String
  author        User        @relation("ReviewAuthor", fields: [authorId], references: [id])
  receiverId    String
  receiver      User        @relation("ReviewReceiver", fields: [receiverId], references: [id])
  
  createdAt     DateTime    @default(now())

  // MUDANÇA AQUI: Garante que um autor só avalie o mesmo agendamento 1 vez
  @@unique([appointmentId, authorId]) 
}

model CashRegister {
  id            String   @id @default(uuid())
  date          DateTime @default(now()) 
  status        String   @default("OPEN") 
  initialValue  Float    @default(0.0)    
  totalIncome   Float    @default(0.0)    
  finalValue    Float    @default(0.0)    
  openedAt      DateTime @default(now())
  closedAt      DateTime?
  proId         String
  professional  User     @relation(fields: [proId], references: [id])
}

model ChatMessage {
  id         String   @id @default(uuid())
  content    String
  createdAt  DateTime @default(now())
  senderId   String
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
}

// --- NOVO MODEL: NOTAS PRIVADAS ---
model ClientNote {
  id        String   @id @default(uuid())
  content   String   
  
  proId     String   
  clientId  String   
  
  professional User @relation("NotesWritten", fields: [proId], references: [id])
  client       User @relation("NotesReceived", fields: [clientId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([proId, clientId]) // Só uma nota por cliente/pro
}